<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI Chatbot MVP</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0b1220;
      --border:#1f2937; --border2:#243244; --text:#e6edf3; --muted:#9fb0c0;
      --primary:#2563eb; --danger:#b91c1c; --good:#16a34a;
      --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Noto Sans KR",Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:14px 18px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px;}
    header h1{ margin:0; font-size:15px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border:1px solid var(--border2); border-radius:999px; font-size:12px; color:var(--muted); background:rgba(255,255,255,0.02); }
    .mini-btn{ width:auto; padding:6px 10px; border-radius:999px; font-size:12px; }
    .wrap{ padding:16px; display:grid; grid-template-columns: 420px 1fr; gap:16px; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, select, textarea, button{ width:100%; }
    input, select, textarea{
      background:var(--panel2); border:1px solid var(--border2); border-radius:12px;
      color:var(--text); padding:10px 12px; outline:none;
    }
    textarea{ min-height:88px; resize:vertical; }
    button{
      border:0; border-radius:12px; padding:10px 12px; cursor:pointer;
      font-weight:700; color:white; background:var(--primary);
    }
    button.secondary{ background:#1f2937; }
    button.danger{ background:var(--danger); }
    button:disabled{ opacity:0.45; cursor:not-allowed; }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .tiny{ font-size:12px; color:var(--muted); }
    .two{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .hr{ height:1px; background:var(--border); margin:12px 0; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Chat */
    .chatWrap{ display:flex; flex-direction:column; gap:12px; height: calc(100vh - 32px - 56px); }
    .chatBox{ flex:1; overflow:auto; padding:10px; background:var(--panel2); border:1px solid var(--border2); border-radius:var(--radius); }
    .msg{ margin:10px 0; display:flex; gap:10px; }
    .msg .role{ width:70px; flex:0 0 auto; font-size:12px; color:var(--muted); padding-top:4px; }
    .bubble{
      max-width: 900px;
      background:#0f1a2a; border:1px solid var(--border2); border-radius:14px;
      padding:10px 12px; line-height:1.5;
      white-space:pre-wrap;
    }
    .msg.user .bubble{ background:#111827; }
    .msg.assistant .bubble{ background:#0f1a2a; }
    .msg.system .bubble{ background:#1a1325; }
    .metaLine{ font-size:12px; color:var(--muted); margin-top:6px; }
    .inputBar{ display:grid; grid-template-columns: 1fr 140px 140px; gap:10px; align-items:stretch; }
    .inputBar textarea{ min-height:52px; height:52px; resize:none; }
    .statusGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .stat{ background:rgba(255,255,255,0.02); border:1px solid var(--border2); border-radius:12px; padding:10px; }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ font-size:13px; margin-top:6px; word-break:break-all; }
    .good{ color:#86efac; }
    .bad{ color:#fca5a5; }

    .tabs{ display:flex; gap:8px; margin-top:10px; }
    .tab{ padding:8px 10px; border-radius:10px; border:1px solid var(--border2); background:var(--panel2);
      cursor:pointer; font-size:12px; color:var(--muted); user-select:none; }
    .tab.active{ background:#111c2e; color:var(--text); border-color:#2b3e5f; }
    .hidden{ display:none !important; }
    .charCard{ display:flex; gap:10px; align-items:center; padding:10px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2); }
    .charImg{ width:48px; height:48px; border-radius:10px; object-fit:cover; border:1px solid var(--border2); background:#0a0f18; }
    .charMeta{ font-size:12px; color:var(--muted); line-height:1.4; }
    .charName{ font-size:13px; color:var(--text); font-weight:700; }
    .scenarioCard{ padding:10px; border:1px solid var(--border2); border-radius:12px; background:var(--panel2); }
    .scenarioLabel{ font-size:12px; color:var(--muted); }
    .scenarioValue{ margin-top:4px; font-size:13px; color:var(--text); }

    a{ color:#93c5fd; text-decoration:none; }
  </style>
</head>
<body>
<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <h1>AI Chatbot MVP</h1>
    <span class="pill" id="pillStatus">idle</span>
  </div>
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
    <span class="pill">session: <span class="mono" id="pillSession">-</span></span>
    <button id="logoutBtn" class="secondary mini-btn">로그아웃</button>
  </div>
</header>

<div class="wrap">
  <!-- Left panel -->
  <div class="card" style="overflow:auto; max-height: calc(100vh - 32px - 56px);">
    <h2 style="margin:0 0 8px; font-size:14px;">Controls</h2>

    <div class="two">
      <div>
        <label>Character</label>
        <select id="character"></select>
      </div>
      <div>
        <label>Scenario</label>
        <select id="scenario"></select>
      </div>
    </div>
    <div class="charCard" style="margin-top:10px;">
      <img id="characterImage" class="charImg" alt="character" />
      <div class="charMeta">
        <div class="charName" id="characterName">-</div>
        <div id="characterDesc">-</div>
      </div>
    </div>
    <div class="scenarioCard" style="margin-top:10px;">
      <div class="scenarioLabel">Goal</div>
      <div class="scenarioValue" id="scenarioGoal">-</div>
      <div class="scenarioLabel" style="margin-top:8px;">Outline</div>
      <div class="scenarioValue" id="scenarioOutline">-</div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnReloadCatalog" class="secondary">캐릭터/시나리오 새로고침</button>
      <button id="btnCreateSession">세션 생성</button>
    </div>

    <div class="hr"></div>

    <div class="tabs">
      <div class="tab active" data-tab="replay">Replay</div>
      <div class="tab" data-tab="debug">Debug</div>
    </div>

    <!-- Replay Tab -->
    <div id="tab-replay" style="margin-top:10px;">
      <label>Replay Session ID</label>
      <input id="replaySessionId" placeholder="예: 0ef3...fec08b" />

      <div class="row" style="margin-top:10px;">
        <button id="btnReplay" class="secondary">세션 로그 불러오기</button>
        <button id="btnReplayToChat" class="secondary">채팅창에 로드</button>
      </div>

      <div class="tiny" style="margin-top:10px; line-height:1.5;">
        우선 <code>GET /session/{id}/messages</code>로 시도하고, 실패하면 <code>/admin/sessions/{id}/messages</code>로 자동 fallback 합니다.
      </div>
    </div>

    <!-- Debug Tab -->
    <div id="tab-debug" class="hidden" style="margin-top:10px;">
      <div class="statusGrid">
        <div class="stat">
          <div class="k">memory_stats</div>
          <div class="v" id="dbgMemoryStats">-</div>
        </div>
        <div class="stat">
          <div class="k">last_error</div>
          <div class="v" id="dbgLastError">-</div>
        </div>
        <div class="stat">
          <div class="k">streaming</div>
          <div class="v" id="dbgStreaming">false</div>
        </div>
      </div>

      <div class="hr"></div>

      <label>Persona Prompt (selected)</label>
      <textarea id="dbgPersona" readonly></textarea>

      <label>Scenario Prompt (selected)</label>
      <textarea id="dbgScenario" readonly></textarea>
    </div>

    <div class="hr"></div>

    <div class="tiny" style="line-height:1.6;">
      Catalog:
      <a href="#" id="linkCharacters">/catalog/characters</a> /
      <a href="#" id="linkScenarios">/catalog/scenarios</a><br/>
      API Docs:
      <a href="#" id="linkDocs">/docs</a>
    </div>
  </div>

  <!-- Right: chat -->
  <div class="card chatWrap">
    <div class="statusGrid"></div>

    <div class="chatBox" id="chatBox"></div>

    <div class="inputBar">
      <textarea id="inputText" placeholder="메시지를 입력하세요. (Shift+Enter 줄바꿈)"></textarea>
      <button id="btnSend">Send</button>
      <button id="btnStop" class="danger" disabled>Stop</button>
    </div>

    <div class="tiny">
      SSE: <code>POST /chat/stream</code> (text/event-stream). 서버가 meta 이벤트를 추가로 보내면 자동 표시됩니다.
    </div>
  </div>
</div>

<script>
  // 로그인 가드: 최초 접속 시 로그인 페이지로 보냄
  const userId = localStorage.getItem("user_id");
  if (!userId) location.href = "./login.html";
  const API_BASE = localStorage.getItem("api_base") || "https://aichatbot-ez4g.onrender.com";

  const $ = (id) => document.getElementById(id);

  let catalog = { characters: [], scenarios: [] };
  let currentSession = null;
  let streaming = false;
  let abortController = null;

  // meta state
  let meta = {
    model: "-",
    memory_stats: { saved:0, skipped_dup:0, skipped_low:0 },
    last_error: "-"
  };

  function setPillStatus(text){ $("pillStatus").textContent = text; }
  function setApiPill(){
    const base = API_BASE;
    $("linkDocs").href = base + "/docs";
    $("linkCharacters").href = base + "/catalog/characters";
    $("linkScenarios").href = base + "/catalog/scenarios";
  }
  function setSessionPill(){
    $("pillSession").textContent = currentSession?.id || "-";
  }
  function setError(msg){
    meta.last_error = msg || "-";
    const statError = document.getElementById("statError");
    if (statError) statError.textContent = meta.last_error;
    $("dbgLastError").textContent = meta.last_error;
  }
  function setModel(m){
    meta.model = m || "-";
    const statModel = document.getElementById("statModel");
    if (statModel) statModel.textContent = meta.model;
  }
  function setMemoryStats(obj){
    if (!obj) return;
    meta.memory_stats.saved = obj.saved ?? meta.memory_stats.saved;
    meta.memory_stats.skipped_dup = obj.skipped_dup ?? meta.memory_stats.skipped_dup;
    meta.memory_stats.skipped_low = obj.skipped_low ?? meta.memory_stats.skipped_low;

    const statMemory = document.getElementById("statMemory");
    if (statMemory){
      statMemory.textContent = `saved:${meta.memory_stats.saved} dup:${meta.memory_stats.skipped_dup} low:${meta.memory_stats.skipped_low}`;
    }
    $("dbgMemoryStats").textContent = JSON.stringify(meta.memory_stats);
  }
  function setStreaming(v){
    streaming = !!v;
    $("dbgStreaming").textContent = streaming ? "true" : "false";
    $("btnStop").disabled = !streaming;
    $("btnSend").disabled = streaming;
  }

  async function apiFetch(path, opts={}){
    setApiPill();
    const base = API_BASE;
    const headers = {
      ...(opts.headers || {}),
    };
    if (path.startsWith("/admin/")) {
      const adminKey = localStorage.getItem("admin_api_key");
      if (adminKey) headers["X-Admin-Key"] = adminKey;
    }
    const res = await fetch(base + path, { ...opts, headers });
    if (!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${res.statusText} :: ${t}`);
    }
    return res;
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function appendMsg(role, text, metaLine=""){
    const box = $("chatBox");
    const div = document.createElement("div");
    div.className = "msg " + role;
    div.innerHTML = `
      <div class="role">${role.toUpperCase()}</div>
      <div style="flex:1;">
        <div class="bubble" data-role="${role}">${escapeHtml(text)}</div>
        ${metaLine ? `<div class="metaLine">${escapeHtml(metaLine)}</div>` : ""}
      </div>
    `;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    return div.querySelector(".bubble");
  }

  function updateLastAssistantBubbleText(bubble, text){
    bubble.innerHTML = escapeHtml(text);
    const box = $("chatBox");
    box.scrollTop = box.scrollHeight;
  }

  // ---------- Tabs ----------
  function showTab(name){
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    $("tab-replay").classList.toggle("hidden", name !== "replay");
    $("tab-debug").classList.toggle("hidden", name !== "debug");
  }
  document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", () => showTab(t.dataset.tab)));

  // ---------- Catalog ----------
  async function loadCatalog(){
    setPillStatus("loading catalog...");
    try{
      const [cRes, sRes] = await Promise.all([
        apiFetch("/catalog/characters"),
        apiFetch("/catalog/scenarios")
      ]);
      const cJson = await cRes.json();
      const sJson = await sRes.json();

      catalog.characters = cJson.items || [];
      catalog.scenarios = sJson.items || [];

      const charSel = $("character");
      const scnSel = $("scenario");

      charSel.innerHTML = "";
      catalog.characters.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = `${c.name} (${c.id})`;
        opt.dataset.persona = c.persona_prompt || "";
        opt.dataset.image = c.image_url || "";
        opt.dataset.name = c.name || "";
        opt.dataset.desc = c.description || "";
        charSel.appendChild(opt);
      });

      scnSel.innerHTML = "";
      catalog.scenarios.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.name} (${s.id})`;
        opt.dataset.scenario = s.scenario_prompt || "";
        opt.dataset.goal = s.goal || "";
        opt.dataset.outline = s.outline || "";
        opt.dataset.story = s.story || "";
        opt.dataset.first = s.first_message || "";
        scnSel.appendChild(opt);
      });

      updateDebugPrompts();
      setPillStatus("catalog loaded");
    }catch(e){
      setError(e.message);
      setPillStatus("catalog error");
      alert(e.message);
    }
  }

  function updateDebugPrompts(){
    const charOpt = $("character").selectedOptions[0];
    const scnOpt = $("scenario").selectedOptions[0];
    $("dbgPersona").value = charOpt?.dataset.persona || "";
    $("dbgScenario").value = scnOpt?.dataset.scenario || "";
    const imgEl = $("characterImage");
    const nameEl = $("characterName");
    const descEl = $("characterDesc");
    const imgRaw = charOpt?.dataset.image || "";
    const imgUrl = imgRaw && !imgRaw.startsWith("http") && !imgRaw.startsWith("/")
      ? "/" + imgRaw
      : imgRaw;
    if (imgEl) imgEl.src = imgUrl || "";
    if (nameEl) nameEl.textContent = charOpt?.dataset.name || charOpt?.textContent || "-";
    if (descEl) descEl.textContent = charOpt?.dataset.desc || "-";
    const goalEl = $("scenarioGoal");
    const outlineEl = $("scenarioOutline");
    if (goalEl) goalEl.textContent = scnOpt?.dataset.goal || "-";
    if (outlineEl) outlineEl.textContent = scnOpt?.dataset.outline || "-";
  }
  $("character").addEventListener("change", updateDebugPrompts);
  $("scenario").addEventListener("change", updateDebugPrompts);

  $("btnReloadCatalog").addEventListener("click", () => loadCatalog());

  // ---------- Session ----------
  async function createSession(){
    const user_id = localStorage.getItem("user_id");
    if (!user_id) return alert("로그인 후 이용하세요.");

    const character_id = $("character").value;
    const scenario_id = $("scenario").value;

    setPillStatus("creating session...");
    setError("-");
    try{
      const res = await apiFetch("/session/create", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ user_id, character_id, scenario_id })
      });
      const json = await res.json();
      currentSession = json.session;
      setSessionPill();
      setPillStatus("session active");

      // first message
      const scn = json.scenario;
      if (scn?.first_message){
        appendMsg("system", scn.first_message, `scenario: ${scn.name || scenario_id}`);
      }
    }catch(e){
      setError(e.message);
      setPillStatus("session error");
      alert(e.message);
    }
  }
  $("btnCreateSession").addEventListener("click", () => createSession());

  // ---------- Replay ----------
  let replayCache = null;

  async function fetchSessionMessages(sessionId){
    // try public endpoint first
    try{
      const res = await apiFetch(`/session/${encodeURIComponent(sessionId)}/messages`);
      const json = await res.json();
      return json.items || json.messages || json || [];
    }catch(e1){
      // fallback to admin endpoint
      const res2 = await apiFetch(`/admin/sessions/${encodeURIComponent(sessionId)}/messages?limit=400`);
      const json2 = await res2.json();
      return json2.items || [];
    }
  }

  async function replayLoad(){
    const sid = $("replaySessionId").value.trim();
    if (!sid) return alert("replay session id를 입력하세요.");
    setPillStatus("replay loading...");
    try{
      replayCache = await fetchSessionMessages(sid);
      setPillStatus(`replay loaded (${replayCache.length})`);
      alert(`불러옴: ${replayCache.length} messages`);
    }catch(e){
      setError(e.message);
      setPillStatus("replay error");
      alert(e.message);
    }
  }

  function replayToChat(){
    if (!replayCache) return alert("먼저 로그를 불러오세요.");
    // clear and render
    $("chatBox").innerHTML = "";
    replayCache.forEach(m => {
      const role = (m.role || "user").toLowerCase();
      const content = m.content || m.text || "";
      appendMsg(role === "assistant" ? "assistant" : role === "system" ? "system" : "user", content);
    });
    setPillStatus("replay rendered");
  }

  $("btnReplay").addEventListener("click", () => replayLoad());
  $("btnReplayToChat").addEventListener("click", () => replayToChat());

  // ---------- Streaming (POST SSE) ----------
  function parseSseLines(buffer){
    // returns [events, restBuffer]
    const events = [];
    let rest = buffer;

    while (true){
      const idx = rest.indexOf("\n\n");
      if (idx === -1) break;
      const rawEvent = rest.slice(0, idx);
      rest = rest.slice(idx + 2);

      // collect data: lines
      const lines = rawEvent.split("\n");
      const dataLines = lines
        .filter(l => l.startsWith("data:"))
        .map(l => l.slice(5).trimStart());

      if (dataLines.length){
        const dataStr = dataLines.join("\n");
        events.push(dataStr);
      }
    }
    return [events, rest];
  }

  async function sendMessage(text){
    if (!currentSession?.id) return alert("먼저 세션을 생성하세요.");
    const cleaned = (text || "").trim();
    if (!cleaned) return;

    setError("-");
    setStreaming(true);
    setPillStatus("streaming...");

    // Render user bubble
    appendMsg("user", cleaned, `session: ${currentSession.id}`);

    // Prepare assistant bubble for incremental updates
    let assistantAccum = "";
    const assistantBubble = appendMsg("assistant", "", "");

    // Abort controller
    abortController = new AbortController();

    try{
      const payload = {
        session_id: currentSession.id,
        text: cleaned
      };

      const res = await apiFetch("/chat/stream", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Accept":"text/event-stream"
        },
        body: JSON.stringify(payload),
        signal: abortController.signal
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = "";

      while (true){
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream:true });

        const [events, rest] = parseSseLines(buffer);
        buffer = rest;

        for (const ev of events){
          // server sends JSON per data:
          let obj = null;
          try{
            obj = JSON.parse(ev);
          }catch{
            // ignore malformed data
            continue;
          }

          if (obj.type === "meta"){
            if (obj.event === "start"){
              setModel(obj.model || "-");
              // show debug
            }
            if (obj.event === "memory_saved"){
              // increment saved optimistically if stats not provided
              setMemoryStats({ saved: (meta.memory_stats.saved + 1) });
            }
            if (obj.event === "memory_stats"){
              setMemoryStats(obj);
            }
          }else if (obj.type === "delta"){
            assistantAccum += (obj.text || "");
            updateLastAssistantBubbleText(assistantBubble, assistantAccum);
          }else if (obj.type === "error"){
            setError(obj.message || "stream error");
            // show in assistant bubble if nothing
            if (!assistantAccum){
              assistantAccum = "[Error] " + (obj.message || "unknown");
              updateLastAssistantBubbleText(assistantBubble, assistantAccum);
            }
          }
        }
      }

      setPillStatus("done");

    }catch(e){
      if (e.name === "AbortError"){
        setPillStatus("stopped");
      }else{
        setError(e.message);
        setPillStatus("stream error");
        alert(e.message);
      }
    }finally{
      setStreaming(false);
      abortController = null;
    }
  }

  $("btnSend").addEventListener("click", async () => {
    const t = $("inputText").value;
    $("inputText").value = "";
    await sendMessage(t);
  });

  $("btnStop").addEventListener("click", () => {
    if (abortController){
      abortController.abort();
    }
  });

  // Enter to send (Shift+Enter newline)
  $("inputText").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      $("btnSend").click();
    }
  });

  // links
  $("linkDocs").addEventListener("click", (e) => { setApiPill(); });
  $("linkCharacters").addEventListener("click", (e) => { setApiPill(); });
  $("linkScenarios").addEventListener("click", (e) => { setApiPill(); });
  $("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("user_id");
    location.href = "./login.html";
  });

  // init
  window.addEventListener("load", async () => {
    setApiPill();
    setSessionPill();
    setModel("-");
    setMemoryStats({ saved:0, skipped_dup:0, skipped_low:0 });
    setError("-");

    await loadCatalog();
  });
</script>
</body>
</html>
